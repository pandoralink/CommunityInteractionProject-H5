<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <title></title>
    <link href="./comment/MessageBoard.css" rel="stylesheet" />
  </head>

  <body>
    <div id="app">
      <div class="head">
      </div>
      <div class="main"></div>
      <div class="footer">
        <div class="comment">
          <post-comment
            ref="comment"
            @add="addMessage"
            @click="replyArticle"
            @cancel="cancel"
            :remote-base-url="remoteBaseUrl"
            :new-id="newId"
            :commentator-id="userId"
            :commentator-name="userName"
            :commentator-head-url="userHeadUrl"
            placeholder="回复文章"
          ></post-comment>
          <div class="main">
            <message
              v-for="(item,index) in list"
              :key="index"
              :id="item.comment_id"
              :content="item.content"
              :create-time="item.create_time"
              :son="item.son"
              :remote-base-url="remoteBaseUrl"
              :name="item.commentator_name"
              :head-url="item.commentator_head_url"
              @add="reply"
            ></message>
          </div>
        </div>
      </div>
    </div>
  </body>

  <script src="./lib/vue@3.2.6.js"></script>
  <script src="./lib/axios@0.21.1.js"></script>
  <script type="module">
    import config from "./lib/config.js";
    import Message from "./comment/Message.js";
    import PostComment from "./comment/PostComment.js";
    /**
     * currentReplyId 是当前回复的 parentId
     * currentChildArr 是当前回复的 <message> 的 son: Array
    */
    const article = {
      data() {
        return {
          userName: "",
          remoteBaseUrl: "",
          list: "",
          newId: "",
          userId: "",
          userHeadUrl: "",
          currentReplyId: 0,
          replayUserFlag: false,
          currentChildArr: [],
        };
      },
      created() {
        this.initData();
        this.initCommentData();
      },
      methods: {
        initData() {
          this.userName = localStorage.getItem("userName")
            ? localStorage.getItem("userName")
            : null;
          this.userId = localStorage.getItem("userId")
            ? localStorage.getItem("userId")
            : null;
          this.userHeadUrl = localStorage.getItem("userHeadUrl")
            ? localStorage.getItem("userHeadUrl")
            : "";
          this.newId = localStorage.getItem("newId")
            ? localStorage.getItem("newId")
            : null;
          this.remoteBaseUrl = config.baseUrl ? config.baseUrl : "";
        },
        initCommentData() {
          axios
            .get(config.baseUrl + "/getCommentData" + "?new_id=" + this.newId)
            .then((res) => {
              let content = res.data.data;
              content.forEach((item, index) => {
                content[index].son = [];
              });
              let data = [];
              let key = [];
              let index = 0;
              content.forEach((item) => {
                if (item.parent_id == 0) {
                  data.push(item);
                  console.log(item.comment_id);
                  key[item.comment_id] = index;
                  index++;
                } else {
                  if (key[item.parent_id] == undefined) {
                    for (let i = 0; i < key.length; i++) {
                      if (key[i] != undefined) {
                        data[key[i]].son.forEach((element) => {
                          if (element.comment_id == item.parent_id)
                            data[key[i]].son.push(item);
                        });
                      }
                    }
                  } else data[key[item.parent_id]].son.push(item);
                }
              });
              this.list = data;
              this.flag = true;
            })
            .catch((err) => {
              console.log(err);
            });
        },
        addMessage(e) {
          e.parent_id = this.currentReplyId;
          this.currentChildArr.push(e);
          this.currentReplyId = 0;
          this.$refs.comment.content = "";
        },
        reply(e) {
          this.$refs.comment.content = "";
          this.currentChildArr = e.arr;
          this.replayUserFlag = true;
          this.currentReplyId = e.id;
          const commentTextAreaDom = this.$refs.comment.$el.querySelector('textarea');
          commentTextAreaDom.select();
          commentTextAreaDom.placeholder = "回复" + e.name;
        },
        replyArticle() {
          if(!this.replayUserFlag) {
            this.currentReplyId = 0;
            this.$refs.comment.$el.querySelector('textarea').placeholder = "回复文章";
          }
        },
        cancel() {
          this.replayUserFlag = false;
          this.replyArticle();
        }
      },
    };

    const app = Vue.createApp(article);
    app.component("message", Message);
    app.component("PostComment", PostComment);
    app.mount("#app");
  </script>
</html>
