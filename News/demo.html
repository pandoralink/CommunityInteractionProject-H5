<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <title></title>
    <link href="./comment/MessageBoard.css" rel="stylesheet" />
  </head>

  <body>
    <div id="app">
      <div class="head"></div>
      <div class="main"></div>
      <div class="footer">
        <div class="comment">
          <post-comment
            ref="comment"
            @add="addMessage"
            @reply="replyArticle"
            @cancel="cancel"
            :remote-base-url="remoteBaseUrl"
            :new-id="parseInt(newId)"
            :commentator-id="parseInt(userId)"
            :commentator-name="userName"
            :commentator-head-url="userHeadUrl"
            :rid="parseInt(currentReplyUid)"
            :rname="currentReplyUserName"
            placeholder="回复文章"
          ></post-comment>
          <div class="main">
            <message
              v-for="(item,index) in list"
              :key="index"
              :id="item.comment_id"
              :content="item.content"
              :create-time="item.create_time"
              :son="item.son"
              :uid="item.commentator_id"
              :name="item.commentator_name"
              :head-url="item.commentator_head_url"
              @add="reply"
              first
            ></message>
          </div>
        </div>
      </div>
    </div>
  </body>

  <script src="./lib/vue@3.2.6.js"></script>
  <script src="./lib/axios@0.21.1.js"></script>
  <script src="./lib/dayjs.min.js"></script>
  <script type="module">
    import config from "./lib/config.js";
    import Message from "./comment/Message.js";
    import PostComment from "./comment/PostComment.js";
    /**
     * currentReplyId 是当前回复的 <message> 在 comment 表中的 id
     * currentChildArr 是当前回复的 <message> 的 son: Array
     */
    const article = {
      data() {
        return {
          userName: "",
          remoteBaseUrl: "",
          LocalData: [
            {
              id: 3,
              comment_id: 1,
              new_id: 3,
              content: "test",
              create_time: "2021-09-04T09:33:12.000Z",
              commentator_id: 1005,
              commentator_name: "庞老闆",
              commentator_head_url:
                "http://116.63.152.202:5002/userHead/default_head.png",
              parent_id: 0,
            },
            {
              id: 6,
              comment_id: 2,
              new_id: 3,
              content: "一条新评论",
              create_time: "2021-09-04T09:33:12.000Z",
              commentator_id: 1003,
              commentator_name: "梁祖豪",
              commentator_head_url:
                "http://116.63.152.202:5002/userHead/default_head.png",
              parent_id: 0,
            },
            {
              id: 8,
              comment_id: 3,
              new_id: 3,
              content: "回复 comment_id 为 1 的评论",
              create_time: "2021-09-04T09:42:49.000Z",
              commentator_id: 1003,
              commentator_name: "梁祖豪",
              commentator_head_url:
                "http://116.63.152.202:5002/userHead/default_head.png",
              parent_id: 1,
            },
            {
              id: 9,
              comment_id: 4,
              new_id: 3,
              content: "回复 comment_id 为 1 的评论",
              create_time: "2021-09-04T09:42:49.000Z",
              commentator_id: 1003,
              commentator_name: "梁祖豪",
              commentator_head_url:
                "http://116.63.152.202:5002/userHead/default_head.png",
              parent_id: 1,
            },
          ],
          list: [],
          newId: "",
          userId: "",
          userHeadUrl: "",
          replayUserFlag: false,
          currentReplyId: 0,
          currentReplyUid: "",
          currentChildArr: [],
          currentReplyUserName: "",
        };
      },
      created() {
        this.initData();
        this.initCommentData();
      },
      methods: {
        initData() {
          this.userName = localStorage.getItem("userName")
            ? localStorage.getItem("userName")
            : null;
          this.userId = localStorage.getItem("userId")
            ? localStorage.getItem("userId")
            : null;
          this.userHeadUrl = localStorage.getItem("userHeadUrl")
            ? localStorage.getItem("userHeadUrl")
            : "";
          this.newId = localStorage.getItem("newId")
            ? localStorage.getItem("newId")
            : null;
          this.remoteBaseUrl = config.baseUrl ? config.baseUrl : "";
        },
        initCommentData() {
          let content = this.LocalData;
          content.forEach((item, index) => {
            content[index].son = [];
          });
          let data = [];
          let key = [];
          let index = 0;
          content.forEach((item) => {
            if (item.parent_id == 0) {
              data.push(item);
              console.log(item.comment_id);
              key[item.comment_id] = index;
              index++;
            } else {
              if (key[item.parent_id] == undefined) {
                for (let i = 0; i < key.length; i++) {
                  if (key[i] != undefined) {
                    data[key[i]].son.forEach((element, index) => {
                      if (element.comment_id == item.parent_id)
                        data[key[i]].son.push(item);
                      data[key[i]].son[index].rname = element.commentator_name;
                    });
                  }
                }
              } else data[key[item.parent_id]].son.push(item);
            }
          });
          this.list = data;
          // axios
          //   .get(config.baseUrl + "/getCommentData" + "?new_id=" + this.newId)
          //   .then((res) => {
          //     let content = res.data.data;
          //     content.forEach((item, index) => {
          //       content[index].son = [];
          //     });
          //     let data = [];
          //     let key = [];
          //     let index = 0;
          //     content.forEach((item) => {
          //       if (item.parent_id == 0) {
          //         data.push(item);
          //         console.log(item.comment_id);
          //         key[item.comment_id] = index;
          //         index++;
          //       } else {
          //         if (key[item.parent_id] == undefined) {
          //           for (let i = 0; i < key.length; i++) {
          //             if (key[i] != undefined) {
          //               data[key[i]].son.forEach((element) => {
          //                 if (element.comment_id == item.parent_id)
          //                   data[key[i]].son.push(item);
          //               });
          //             }
          //           }
          //         } else data[key[item.parent_id]].son.push(item);
          //       }
          //     });
          //     this.list = data;
          //     this.flag = true;
          //   })
          //   .catch((err) => {
          //     console.log(err);
          //   });
        },
        addMessage(e) {
          e.parent_id = this.currentReplyId;
          e.rname = this.currentReplyUserName;
          this.currentChildArr.push(e);
          this.currentReplyId = 0;
          this.$refs.comment.content = "";
        },
        reply(e) {
          this.$refs.comment.content = "";
          this.replayUserFlag = true;
          this.currentChildArr = e.arr;
          this.currentReplyUid = e.uid;
          this.currentReplyId = e.id;
          this.currentReplyUserName = e.name;
          const commentTextAreaDom = this.$refs.comment.$el.querySelector(
            "textarea"
          );
          commentTextAreaDom.select();
          commentTextAreaDom.placeholder = "回复" + e.name;
        },
        replyArticle() {
          if (!this.replayUserFlag) {
            this.currentReplyId = 0;
            this.$refs.comment.$el.querySelector("textarea").placeholder =
              "回复文章";
          }
        },
        cancel() {
          this.replayUserFlag = false;
          // 操作 Dom 元素是因为修改直接修改 placeholder 元素更新失败
          this.$refs.comment.$el.querySelector("textarea").placeholder =
            "回复文章";
        },
      },
    };

    const app = Vue.createApp(article);
    app.component("message", Message);
    app.component("PostComment", PostComment);
    app.mount("#app");
  </script>
</html>
